<html>

<head>
    <link rel="stylesheet" href="//unpkg.com/element-ui@2.4.6/lib/theme-chalk/index.css">
    <script src="//unpkg.com/vue@2.5.17/dist/vue.js"></script>
    <script src="//unpkg.com/element-ui@2.4.6/lib/index.js"></script>
    <script src="./third_party/qrcode.js"></script>
</head>

<body>
    <div id="app" style="max-width: 960px; margin: 0 auto;">

        <h1>淘宝QR生成器</h1>
        <div style="margin: 20px 0;"></div>
        <el-row>
            <el-col :span="11">
                查询词：
                <el-input v-model="parameters.query" placeholder="查询词"></el-input>
            </el-col>
            <el-col :span="2">&nbsp;
            </el-col>
            <el-col :span="11">
                价格：
                <el-input v-model="parameters.price" placeholder="价格"></el-input>
            </el-col>
        </el-row>
        <div style="margin: 20px 0; "></div>
        <el-row>
            链接: <a :href="url">{{ url }}</a>
        </el-row>
        <div style="margin: 20px 0; "></div>
        <el-row>
            <el-col :span="24 ">
                <div id="qrcode"></div>
            </el-col>
        </el-row>
        <div style="margin: 20px 0; "></div>
        <iframe id="taobao" width="100%" height="100%"></iframe>
    </div>
</body>

<script>
    function getUrl(parameters) {
        const q = encodeURIComponent(parameters.query);
        const p = encodeURIComponent(parameters.price);
        return `https://s.m.taobao.com/h5?q=%3Cbr/%3E${q}%3Cbr/%3E&start_price=${p}&end_price=${p}`;
    }
    let app = new Vue({
        el: '#app',
        data: {
            parameters: {
                query: '',
                price: 0,
            }
        },
        computed: {
            url() {
                return getUrl(this.parameters);
            }
        },
        watch: {
            'parameters.query'() {
                startUpdateQR();
            },
            'parameters.price'() {
                startUpdateQR();
            }
        }
    })
    let timer = null;
    function startUpdateQR() {
        if (timer) {
            clearTimeout(timer);
        }
        timer = setTimeout(updateQR, 500);
    }
    function updateQR() {
        var qr = document.getElementById("qrcode");
        while (qr.firstChild) {
            qr.removeChild(qr.firstChild);
        }
        const url = getUrl(app.parameters);
        new QRCode(qr, url);
        document.getElementById("taobao").setAttribute("src", url);
    }
</script>

</html>